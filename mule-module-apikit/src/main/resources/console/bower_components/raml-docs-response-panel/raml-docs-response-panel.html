<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-styles/paper-styles.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../markdown-styles/markdown-styles.html">
<link rel="import" href="../docs-parameters-table/docs-body-parameters-table.html">
<!--
`<raml-docs-response-panel>` Element that displays response documentation for RAML

This element is used in `<raml-docs-method-viewer>` element.
See it's demo for demo.

### Example
```
<raml-docs-response-panel responses="[[raml.responses]]"></raml-docs-response-panel>
```

The `raml.responses` is a list of responses for current method. It can be
obtained using a `raml-path-to-object` element or by passing method Definition
from RAML's JSON structure.
Note, you have to use ARC's `<raml-js-parser>` since it is also responsoble
for transformind parser JSON output to internal data structure.

## Element's width and overflow
The code blocks generated by the element can be wide. This is why this element
has the CSS `overflow` property set to `auto` by default. In this case you can
set the `max-width` or `width` propety on this element (or any parent element)
and it will be respected.


### Styling
`<raml-docs-response-panel>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--raml-docs-response-panel` | Mixin applied to the element | `{}`
`--arc-status-code-color-200` | Color of the 200 status code (ARC theme option) | `rgba(56, 142, 60, 1)` |
`--arc-status-code-color-300` | Color of the 300 status code (ARC theme option) | `rgba(48, 63, 159, 1)` |
`--arc-status-code-color-400` | Color of the 400 status code (ARC theme option) | `rgba(245, 124, 0, 1)` |
`--arc-status-code-color-500` | Color of the 500 status code (ARC theme option) | `rgba(211, 47, 47, 1)` |
`--arc-status-code-bgcolor-200` | Background color of the 200 status code | `rgba(56, 142, 60, 0.12)` |
`--arc-status-code-bgcolor-300` | Background color of the 300 status code | `rgba(48, 63, 159, 0.12)` |
`--arc-status-code-bgcolor-400` | Background color of the 400 status code | `rgba(245, 124, 0, 0.12)` |
`--arc-status-code-bgcolor-500` | Background color of the 500 status code | `rgba(211, 47, 47, 0.12)` |
`--raml-docs-response-panel-codes-border-color` | Border color of the response codes column | `rgba(0, 161, 223, 0.24)`
`--no-info-message` | A mixin applied to the "missing type" paragraph. | `{}` |
`--raml-docs-response-panel-container` | A mixin applied to the element's main container | `{}`
`--raml-docs-response-panel-codes-content` | A mixin applied to the element's status codes container | `{}`
`--raml-docs-response-panel-docs-content` | A mixin applied to the element's documentation content container | `{}`

@group RAML Elements
@element raml-docs-response-panel
@demo demo/index.html
-->
<dom-module id="raml-docs-response-panel">
  <template>
    <style include="markdown-styles"></style>
    <style>
     :host {
      display: block;
      @apply(--raml-docs-response-panel);
    }

    .container {
      @apply(--layout-horizontal);
      @apply(--raml-docs-response-panel-container);
    }

    .codes {
      border-right: 1px var(--raml-docs-response-panel-codes-border-color, rgba(0, 161, 223, 0.24)) solid;
      @apply(--raml-docs-response-panel-codes-content);
    }

    .docs {
      @apply(--layout-flex);
      @apply(--paper-font-body1);
      margin-left: 16px;
      overflow: auto;
      @apply(--raml-docs-response-panel-docs-content);
    }

    .no-data-info {
      @apply(--no-info-message);
    }

    .codes paper-item {
      cursor: pointer;
    }

    .codes .green {
      color: var(--arc-status-code-color-200, rgba(56, 142, 60, 1));
    }

    .codes .green[active]:not([focused])  {
      background-color: var(--arc-status-code-bgcolor-200, rgba(56, 142, 60, 0.12));
    }

    .codes .blue {
      color: var(--arc-status-code-color-300, rgba(48, 63, 159, 1));
    }

    .codes .blue[active]:not([focused])  {
      background-color: var(--arc-status-code-bgcolor-300, rgba(48, 63, 159, 0.12));
    }

    .codes .orange {
      color: var(--arc-status-code-color-400, rgba(245, 124, 0, 1));
    }

    .codes .orange[active]:not([focused]) {
      background-color: var(--arc-status-code-bgcolor-400, rgba(245, 124, 0, 0.12));
    }

    .codes .red {
      color: var(--arc-status-code-color-500, rgba(211, 47, 47, 1));
    }

    .codes .red[active]:not([focused])  {
      background-color: var(--arc-status-code-bgcolor-500, rgba(211, 47, 47, 0.12));
    }

    .markdown-html,
    docs-body-parameters-table {
      margin-right: 12px;
    }

    </style>
    <div class="container" hidden$="[[!hasResponses]]">
      <div class="codes">
        <paper-menu selected="{{selectedResponseStatus}}" selected-attribute="active">
          <template is="dom-repeat" items="[[responses]]">
            <paper-item class$="[[_computeCodeClass(item.code)]]">[[item.code]]</paper-item>
          </template>
        </paper-menu>
      </div>
      <div class="docs">
        <section>
          <template is="dom-if" if="[[description]]">
            <marked-element markdown="[[description]]">
              <div class="markdown-html"></div>
            </marked-element>
          </template>
          <p class="no-data-info" hidden$="[[description]]">No description provided.</p>
          <docs-body-parameters-table hidden$="[[!_hasProperty(selectedResponse, 'body')]]" selected-body-type="{{selectedBodyType}}" body="[[selectedResponse.body]]"></docs-body-parameters-table>
        </section>
      </div>
    </div>
  </template>
  <script>
  Polymer({
    is: 'raml-docs-response-panel',
    properties: {
      // List of responses - RAML definition (JSON)
      responses: Array,
      // Computed value if currently panel has anything to display
      hasResponses: {
        type: Boolean,
        notify: true,
        readOnly: true,
        value: false
      },
      // Selected response in the array (0-based)
      selectedResponseStatus: {
        type: Number,
        value: 0
      },
      // Currently selected response object
      selectedResponse: {
        type: Object,
        value: null,
        computed: '_computeSelectedResponse(selectedResponseStatus, responses.length)'
      },
      // Mime type of the body currently displayed.
      selectedBodyType: {
        type: Object,
        value: null
      },
      // Description for selected response and type.
      description: {
        type: String,
        value: '',
        computed: '_computeDescription(selectedResponse, selectedBodyType, selectedResponseStatus)'
      }
    },

    observers: [
      '_responsesChanged(responses.*)'
    ],

    _responsesChanged: function() {
      this.selectedResponseStatus = 0;
      this.clear();

      var d = this.responses;
      this._setHasResponses(!!(d && d.length));
      if (!this.hasResponses) {
        return;
      }
    },

    clear: function() {
      // this.selectedBodyType = null;
      this.bodyTypes = [];
    },

    _computeSelectedResponse: function(selectedResponseStatus, respSize) {
      if (!selectedResponseStatus && selectedResponseStatus !== 0 || !respSize) {
        return;
      }
      return this.responses[selectedResponseStatus];
    },

    _hasProperty: function(obj, property) {
      if (!obj) {
        return false;
      }
      return property in obj;
    },

    _computeCodeClass: function(code) {
      code = Number(code);
      if (code !== code) {
        return '';
      }
      if (code >= 200 && code < 300) {
        return 'green';
      }
      if (code >= 300 && code < 400) {
        return 'blue';
      }
      if (code >= 400 && code < 500) {
        return 'orange';
      }
      if (code >= 500 && code < 600) {
        return 'red';
      }
    },
    // Computes a description for current selected response and type.
    _computeDescription: function(resp, bodyType) {
      if (!resp) {
        return null;
      }
      if ('description' in resp) {
        return resp.description;
      }
      if (bodyType && resp.body && resp.body.length) {
        for (var i = 0, len = resp.body.length; i < len; i++) {
          if (resp.body[i].key === bodyType) {
            if (resp.body[i].description) {
              return resp.body[i].description;
            }
            break;
          }
        }
      }
      return null;
    }
  });
  </script>
</dom-module>
