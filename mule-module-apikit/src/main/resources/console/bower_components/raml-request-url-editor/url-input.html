<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../paper-styles/typography.html">
<!--
An URL input.
This element preteds to be an `<input>` element in order to add custom behavior to the
input element.

-->
<dom-module id="url-input">
  <template>
    <style>
     :host {
      outline: none;
      box-shadow: none;
      background: transparent;
    }

    .container {
      @apply(--layout-horizontal);
    }

    .user-input {
      width: 100%;
      -webkit-appearance: textfield;
      -webkit-rtl-ordering: logical;
      user-select: text;
      cursor: auto;
      text-rendering: auto;
      letter-spacing: normal;
      word-spacing: normal;
      text-transform: none;
      text-indent: 0px;
      text-shadow: none;
      display: inline-block;
      -webkit-writing-mode: horizontal-tb;
      white-space: nowrap;
      overflow: hidden;
      word-wrap: normal;
      -webkit-line-break: normal;
      outline: none;
      box-shadow: none;
      color: var(--paper-input-container-input-color, --primary-text-color);
      @apply(--layout-flex);
      @apply(--paper-font-subhead);
      @apply(--paper-input-container-input)
    }

    .variable {
      background-color: var(--url-input-marker, yellow);
    }
    </style>
    <div class="container">
      <div class="user-input"
        contenteditable="true"
        id="userInput"
        aria-labelledby$="[[ariaLabel]]"
        disabled$="[[disabled]]"
        readonly$="[[readonly]]"
        on-keyup="_userInputHandler"
        on-keydown="_keyDownHandler"
        on-click="_userInputClickHandler"
        on-blur="_onBlur"></div>
    </div>
  </template>
  <script>
  Polymer({
    is: 'url-input',

    behaviors: [
      Polymer.IronValidatableBehavior
    ],
    /**
     * An event fired when the user press Enter on the input field. It's more reliable than
     * listening on the keydown event.
     *
     * @event request-url-accepted
     * @param {String} url The URL at the moment when the user pressed enter in the field.
     */
    properties: {
      url: {
        type: String,
        notify: true
      },
      /**
       * Set to true to mark the input as required.
       */
      required: {
        type: Boolean,
        value: false
      },

      /**
       * Set to true to disable the month and year input elements.
       */
      disabled: {
        type: Boolean,
        value: false
      },

      /**
       * Set to true to mark the month and year inputs as not editable.
       */
      readonly: {
        type: Boolean,
        value: false
      },
      // A regexp to search for the variables.
      _variablesRegexp: {
        type: RegExp,
        value: function() {
          return /({(\w+)})/g;
        }
      },
      // An aria label generated by parent element.
      ariaLabel: String
    },

    observers: [
      '_urlChanged(url)'
    ],

    hostAttributes: {
      'tabindex': 0
    },

    listeners: {
      'focus': '_onFocus'
    },

    _urlChanged: function(url) {
      if (this._internalValueChange) {
        return;
      }
      var html = this._getInputHtml(url);
      if (!html) {
        this.$.userInput.innerHTML = url;
        return;
      } else {
        this.$.userInput.innerHTML = html;
      }
    },

    // A handler when input in the text field change.
    _userInputHandler: function(e) {
      var raw = e.target.innerText;
      var html = this._getInputHtml(e.target.innerText);
      var position = this._getCarretPosition();
      if (html) {
        e.target.innerHTML = html;
        try {
          this._setCursor(e.target, position);
        } catch (e) {}
      }
      this._internalValueChange = true;
      this.set('url', raw);
      this._internalValueChange = false;
    },
    /**
     * Parses the user input and return a HTML with the markers or null if variables are not
     * in the input string.
     */
    _getInputHtml: function(value) {
      if (!value) {
        return null;
      }
      var match = value.match(this._variablesRegexp);
      if (!match) {
        return null;
      }
      var clsPrefix = 'style-scope ' + this.is;
      var replacement = '<span class="' + clsPrefix + ' variable" data-id="$2">$1</span>';
      var html = value.replace(this._variablesRegexp, replacement);
      return html;
    },

    // Sets the cusror at the ened of the text field.
    _setCursor: function(container, position) {
      container.focus();
      var node = container.childNodes[position[0]];
      var range = document.createRange();
      range.setStart(node, position[1]);
      range.setEnd(node, position[1]);
      var sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    },

    _userInputClickHandler: function(e) {
      var source;
      if (!e.path) {
        e = Polymer.dom(e);
        source = e.rootTarget;
      } else {
        source = e.path[0];
      }

      if (!(source && source.classList && source.classList.contains('variable'))) {
        this.fire('variable-click');
        return;
      }
      var variableId = source.dataset.id;
      if (!variableId) {
        return;
      }
      (e.event || e).stopPropagation();
      this.fire('variable-click', {
        variable: variableId
      });
    },

    _getValidity: function() {
      var value = this.url;
      if (!this.required && !value) {
        return true;
      }
      if (value === undefined) {
        return true; //changint the URL;
      }
      if (!value && this.required) {
        return false;
      }
      if (!value) {
        return true;
      }
      return value.match(this._variablesRegexp) === null;
    },

    _onBlur: function() {
      this.removeAttribute('focused');
      this.removeAttribute('aria-focused');
    },

    _onFocus: function() {
      if (!this.getAttribute('focused')) {
        this.setAttribute('focused', true);
      }
    },

    focus: function() {
      this.$.userInput.focus();
    },

    _getCarretPosition: function() {
      var element = this.$.userInput;
      var pos = 0;
      var containerIndex = 0;
      var selection = window.getSelection();
      if (selection.rangeCount === 1) {
        var range = selection.getRangeAt(0);
        if (range.collapsed) {
          var container = range.startContainer;
          if (container !== element) {
            for (var i = 0, len = element.childNodes.length; i < len; i++) {
              var node = element.childNodes[i];
              if (node === container) {
                containerIndex = i;
                break;
              }
            }
          }
          pos = range.startOffset;
        }
      }
      return [containerIndex, pos];
    },

    _keyDownHandler: function(e) {
      if (e.keyCode === 13) {
        e.preventDefault();
        e.stopPropagation();
        this.fire('request-url-accepted', {
          url: this.url
        });
      }
    }
  });
  </script>
</dom-module>
