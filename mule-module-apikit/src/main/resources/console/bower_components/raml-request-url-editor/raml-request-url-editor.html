<!--
@license
Copyright 2016 The Advanced REST client authors <arc@mulesoft.com>
Licensed under the Apache License, Version 2.0 (the "License"); you may not
use this file except in compliance with the License. You may obtain a copy of
the License at
http://www.apache.org/licenses/LICENSE-2.0
Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
License for the specific language governing permissions and limitations under
the License.
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-input/paper-input-container.html">
<link rel="import" href="../paper-input/paper-input-behavior.html">
<link rel="import" href="../paper-input/paper-input-error.html">
<link rel="import" href="../iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../markdown-styles/markdown-styles.html">
<link rel="import" href="../paper-styles/typography.html">

<link rel="import" href="url-input.html">

<!--
`<raml-request-url-editor>` An URL editor for the RAML request panel

This element is mocking an input element to provide URI variables highlight.
It will mark every occurence of the `{STRING}`. Additionally, if the `uriParameters` array is
set, and the user click on the variable name then the documentation fot this variable will be
displayed. This behavior can be turned off by setting `skip-docs` attribute (`skipDocs` property).

The element also mimic the input's validation behavior. If the value contains s string that matches
the following regexp `{\s+}` then it will display a validation error.

### Example
```html
<raml-request-url-editor auto-validate required></raml-request-url-editor>
```
```javascript
var input = document.querySelector('raml-request-url-editor');
input.addEventListener('value-changed', function(e) {
  if (input.validate())
    var url = e.detail.value;
});
```

When the `value` if this control change then the `url-value-changed` event will be fired.

### Styling
`<raml-request-url-editor>` provides the following custom properties and mixins for styling:

Custom property | Description | Default
----------------|-------------|----------
`--raml-request-url-editor` | Mixin applied to the element | `{}`
`--raml-request-url-editor-documentation` | Mixin applied to the documentation field. Not that this node has the `--paper-font-body1` mixin and also `markdown-styles` applies. | `{}`
`--url-input-marker` | Background color of the URI variable marker | `yellow`

Additionally use styles defined for the `paper-input` element.

@group RAML Elements
@element raml-request-url-editor
@demo demo/index.html
-->
<dom-module id="raml-request-url-editor">
  <template>
    <style include="markdown-styles"></style>
    <style>
    :host {
      outline: none;
      display: block;
      @apply(--raml-request-url-editor);
    }

    .markdown-body {
      @apply(--paper-font-body1);
      margin-top: 12px;
      color: rgba(0, 0, 0, 0.54);
      @apply(--raml-request-url-editor-documentation);
    }

    </style>
    <paper-input-container
      no-label-float="[[noLabelFloat]]"
      attr-for-value="url"
      always-float-label="[[alwaysFloatLabel]]"
      disabled$="[[disabled]]"
      invalid="[[invalid]]">
      <label hidden$="[[!label]]">[[label]]</label>
      <url-input id="input" class="paper-input-input"
        aria-label-prefix="[[_ariaLabelledBy]]"
        url="{{value}}"
        invalid="{{invalid}}"
        disabled$="[[disabled]]"
        required$="[[required]]"
        autofocus$="[[autofocus]]"
        readonly$="[[readonly]]"
        type="url"></url-input>
      <template is="dom-if" if="[[errorMessage]]">
        <paper-input-error>[[errorMessage]]</paper-input-error>
      </template>
    </paper-input-container>
    <template is="dom-if" if="[[documentation]]">
      <marked-element markdown="[[documentation]]">
        <div class="markdown-html markdown-body"></div>
      </marked-element>
    </template>
  </template>
  <script>
  Polymer({
    is: 'raml-request-url-editor',

    behaviors: [
      Polymer.PaperInputBehavior,
      Polymer.IronFormElementBehavior
    ],

    /**
     * Fired when the URL value change.
     * Note that this event is fifed before validation occur and therefore the URL may be invalid.
     *
     * @event url-value-changed
     * @param {String} value The URL.
     */

    properties: {
      // A list of RAML defined URL parameters
      uriParameters: Array,
      // A RAML defined absolute URL for this endpoint. It may contain variables
      url: {
        type: String,
        observer: '_onUrlChanged'
      },
      /**
       * The label for this input.
       */
      label: {
        type: String,
        value: 'Request URL'
      },
      // A value generated by this editor - the URL.
      value: {
        type: String,
        notify: true,
        observer: '_onValueChanged'
      },
      errorMessage: {
        type: String,
        value: 'Fill the URI parameters before making the request'
      },
      // A documentation to show.
      documentation: {
        type: String,
        value: ''
      },
      // If true it will not display documentation for the variable (if available).
      skipDocs: Boolean
    },

    observers: [
      '_onFocusedChanged(focused)'
    ],

    listeners: {
      'variable-click': '_onVariableSelected',
      'blur': '_onElementBlur'
    },

    hostAttributes: {
      'tabindex': -1,
      focusable: true
    },

    ready: function() {
      this._ready = true;
      // If there's an initial input, validate it.
      if (this.value) {
        this._handleAutoValidate();
      }
    },

    attached: function() {
      this._eventTarget = Polymer.dom(this).host || document;
      this.listen(this._eventTarget, 'url-value-changed', '_extValueChangedHandler');
    },
    detached: function() {
      if (!this._eventTarget) {
        return;
      }
      this.unlisten(this._eventTarget, 'url-value-changed', '_extValueChangedHandler');
    },

    /**
     * Overidden from Polymer.PaperInputBehavior.
     */
    validate: function() {
      return this.$.input.validate();
    },

    /**
     * A handler that is called on input
     */
    _onValueChanged: function() {
      if (!this._ready) {
        return;
      }
      this.fire('url-value-changed', {
        value: this.value
      });
      this._handleAutoValidate();
    },

    /**
     * Overidden from Polymer.IronControlState.
     */
    _onFocusedChanged: function(focused) {
      this.debounce('focus', function() {
        if (!focused) {
          this._handleAutoValidate();
        }
      }, 20);
    },
    /**
     * If called it mean that the method has changed. And possibly the url value.
     * If the old value id the same as the new value it means that the user switched a method
     * staying with the same andpoint. Therefore nothing needs to be done.
     */
    _onUrlChanged: function(value, oldValue) {
      if (value === oldValue && value !== undefined) {
        return;
      }
      this.set('value', value);
    },

    _onVariableSelected: function(e, detail) {
      e.stopPropagation();
      var id = detail.variable;
      this._displayVariableDoc(id);
    },
    // Displays the doc for the variable.
    _displayVariableDoc: function(id) {
      if (this.skipDocs) {
        return;
      }
      var up = this.uriParameters;
      if (!id || !up) {
        this.documentation = '';
        return;
      }
      var item;
      for (var i = 0, len = up.length; i < len; i++) {
        if (up[i].name === id) {
          item = up[i];
          break;
        }
      }
      if (!item || !item.description) {
        return;
      }
      this.documentation = item.description;
    },

    _onElementBlur: function() {
      this.documentation = '';
    },

    /**
     * A handler for the `url-value-changed` event.
     * If this element is not the source of the event then it will update the `value` property.
     * It's to be used besides the Polymer's data binding system.
     */
    _extValueChangedHandler: function(e) {
      if (e.target === this) {
        return;
      }
      this.set('value', e.detail.value);
    },
  });
  </script>
</dom-module>
